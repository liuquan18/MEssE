# GNNæ¶æ„å‡çº§æ–‡æ¡£

## ğŸ“š æ¦‚è¿°

å°†ComInæ’ä»¶ä»ç®€å•çš„å…¨è¿æ¥ç¥ç»ç½‘ç»œ(MLP)å‡çº§ä¸º**å›¾ç¥ç»ç½‘ç»œ(GNN)**ï¼Œä¸“é—¨ä¸ºICONéç»“æ„åŒ–ç½‘æ ¼è®¾è®¡ã€‚

---

## ğŸ¯ ä¸ºä»€ä¹ˆä½¿ç”¨GNNï¼Ÿ

### ICONç½‘æ ¼ç‰¹æ€§
- **éç»“æ„åŒ–ç½‘æ ¼**ï¼šICONä½¿ç”¨icosahedral (äºŒåé¢ä½“) ç½‘æ ¼
- **ç©ºé—´æ‹“æ‰‘**ï¼šæ¯ä¸ªç½‘æ ¼å•å…ƒæœ‰æ˜ç¡®çš„é‚»å±…å…³ç³»ï¼ˆé€šå¸¸6ä¸ªé‚»å±…ï¼‰
- **ä¸è§„åˆ™åˆ†å¸ƒ**ï¼šç½‘æ ¼ç‚¹ä¸åœ¨è§„åˆ™çš„ç»çº¬åº¦ç½‘æ ¼ä¸Š

### GNNçš„ä¼˜åŠ¿
1. âœ… **å¤©ç„¶é€‚åˆéç»“æ„åŒ–æ•°æ®**ï¼šç›´æ¥åœ¨å›¾ç»“æ„ä¸Šæ“ä½œ
2. âœ… **åˆ©ç”¨ç©ºé—´å…³ç³»**ï¼šé€šè¿‡é‚»å±…èŠ‚ç‚¹ä¼ é€’ä¿¡æ¯
3. âœ… **æ›´å¥½çš„æ³›åŒ–èƒ½åŠ›**ï¼šå­¦ä¹ å±€éƒ¨æ¨¡å¼ï¼Œé€‚ç”¨äºä¸åŒåˆ†è¾¨ç‡
4. âœ… **ç‰©ç†ä¸€è‡´æ€§**ï¼šç¬¦åˆå¤§æ°”ç‰©ç†çš„å±€éƒ¨æ€§åŸç†

---

## ğŸ” æ‚¨çš„ç†è§£çº æ­£

### å½“å‰ä»£ç çš„å®é™…åšæ³•

**æ‚¨çš„ç†è§£**ï¼š
> "å¦‚æœè¾“å…¥çš„shapeæ˜¯8x16ï¼Œå°†æ¯ä¸ª16ä½œä¸ºç±»ä¼¼epochè¿›è¡Œå¾ªç¯"

**å®é™…æƒ…å†µ**ï¼š
```python
# åŸå§‹ä»£ç 
B = 5  # batch sizeï¼ˆæ‰¹æ¬¡å¤§å°ï¼‰
C = 1  # channelï¼ˆé€šé“æ•°ï¼‰
H = 30  # heightï¼ˆç‰¹å¾ç»´åº¦ï¼‰

one_batch_size = B * C * H  # 150ä¸ªæ•°æ®ç‚¹ä¸ºä¸€ä¸ªbatch

# å‡è®¾æ€»æ•°æ®ç‚¹æ•° = 30,000
num_batches = 30000 // 150  # = 200ä¸ªbatches
```

**å®é™…è®­ç»ƒæµç¨‹**ï¼š
1. å°†30,000ä¸ªæ•°æ®ç‚¹åˆ†æˆ200ä¸ªbatches
2. æ¯ä¸ªbatchåŒ…å«5ä¸ªæ ·æœ¬ï¼Œæ¯ä¸ªæ ·æœ¬30ä¸ªç‰¹å¾
3. å¯¹æ¯ä¸ªbatchæ‰§è¡Œä¸€æ¬¡å‰å‘ä¼ æ’­â†’æŸå¤±è®¡ç®—â†’åå‘ä¼ æ’­â†’æƒé‡æ›´æ–°
4. **ä¸æ˜¯æŒ‰16åšepoch**ï¼Œè€Œæ˜¯æŒ‰batchè¿›è¡Œmini-batchæ¢¯åº¦ä¸‹é™

---

## ğŸ†• GNNæ¶æ„æ”¹è¿›

### 1. æ•°æ®ç»“æ„å˜åŒ–

#### åŸMLPæ–¹å¼ï¼š
```python
# æ•°æ®è¢«reshapeä¸º(batch_size, channels, features)
x_batch_np = x_batch_np.reshape(5, 1, 30)  # [B, C, H]
# è¾“å…¥â†’å…¨è¿æ¥å±‚â†’è¾“å‡º
```

#### æ–°GNNæ–¹å¼ï¼š
```python
# æ•°æ®ä¿æŒä¸ºå›¾ç»“æ„
x = torch.FloatTensor(RHI_MAX_np_glb).unsqueeze(1)  # [num_nodes, 1]
# æ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªç½‘æ ¼å•å…ƒ
# è¾¹ï¼ˆedgesï¼‰è¿æ¥ç›¸é‚»çš„ç½‘æ ¼å•å…ƒ

# è¾“å…¥â†’å›¾å·ç§¯å±‚â†’è¾“å‡º
y_hat = net(x, edge_index)
```

### 2. ç½‘ç»œæ¶æ„å¯¹æ¯”

#### åŸMLPæ¶æ„ï¼š
```python
class MLPNet(nn.Module):
    def __init__(self):
        self.fc1 = nn.Linear(30, 32)    # å…¨è¿æ¥å±‚1
        self.fc2 = nn.Linear(32, 32)    # å…¨è¿æ¥å±‚2
        self.fc3 = nn.Linear(32, 30)    # å…¨è¿æ¥å±‚3
```
- **é—®é¢˜**ï¼šå¿½ç•¥äº†ç©ºé—´ç»“æ„
- **è®¡ç®—é‡**ï¼šæ¯å±‚ 30Ã—32 = 960ä¸ªå‚æ•°

#### æ–°GNNæ¶æ„ï¼š
```python
class GNNNet(nn.Module):
    def __init__(self):
        self.conv1 = GATConv(1, 32, heads=4)     # å›¾æ³¨æ„åŠ›å±‚1
        self.conv2 = GATConv(128, 32, heads=4)   # å›¾æ³¨æ„åŠ›å±‚2
        self.conv_out = GATConv(128, 1, heads=1) # è¾“å‡ºå±‚
```
- **ä¼˜åŠ¿**ï¼šåˆ©ç”¨ç©ºé—´é‚»å±…ä¿¡æ¯
- **æ³¨æ„åŠ›æœºåˆ¶**ï¼šè‡ªåŠ¨å­¦ä¹ å“ªäº›é‚»å±…æ›´é‡è¦
- **å‚æ•°å…±äº«**ï¼šæ‰€æœ‰èŠ‚ç‚¹å…±äº«ç›¸åŒçš„æƒé‡ï¼ˆæ›´é«˜æ•ˆï¼‰

### 3. è®­ç»ƒæ–¹å¼æ”¹è¿›

#### åŸMLPè®­ç»ƒï¼š
```python
# åˆ†æ‰¹è®­ç»ƒï¼ˆmini-batch SGDï¼‰
for i in range(num_batches):
    x_batch = data[i*batch_size : (i+1)*batch_size]
    loss = train_one_batch(x_batch)
```
- æ¯ä¸ªbatchç‹¬ç«‹è®­ç»ƒ
- ä¸è€ƒè™‘ç©ºé—´å…³ç³»

#### æ–°GNNè®­ç»ƒï¼š
```python
# æ•´å›¾è®­ç»ƒï¼ˆfull-batch trainingï¼‰
for epoch in range(10):  # æ¯ä¸ªæ—¶é—´æ­¥è®­ç»ƒ10ä¸ªepoch
    y_hat = net(x_all, edge_index)  # æ•´ä¸ªå›¾ä¸€èµ·è®­ç»ƒ
    loss = criterion(y_hat, y_all)
    loss.backward()
    optimizer.step()
```
- åˆ©ç”¨å®Œæ•´çš„å›¾ç»“æ„
- ä¿¡æ¯åœ¨é‚»å±…é—´ä¼ æ’­
- æ¯ä¸ªæ—¶é—´æ­¥å¤šæ¬¡è¿­ä»£ï¼ˆ10 epochsï¼‰ä»¥å……åˆ†å­¦ä¹ 

---

## ğŸ“Š æ•°æ®æµå¯¹æ¯”

### åŸMLPæ•°æ®æµï¼š
```
RHI_MAX (30000ç‚¹) 
    â†“ reshape
[200 batches Ã— (5 samples Ã— 30 features)]
    â†“ for each batch
å…¨è¿æ¥å±‚ â†’ å…¨è¿æ¥å±‚ â†’ å…¨è¿æ¥å±‚
    â†“
QI_MAXé¢„æµ‹
```

### æ–°GNNæ•°æ®æµï¼š
```
RHI_MAX (30000ç‚¹) + åæ ‡(lon, lat)
    â†“ 
[30000 nodes Ã— 1 feature] + [edgesè¿æ¥ç›¸é‚»èŠ‚ç‚¹]
    â†“ æ„å»ºk-NNå›¾ (k=6é‚»å±…)
å›¾æ³¨æ„åŠ›å±‚1 â†’ å›¾æ³¨æ„åŠ›å±‚2 â†’ å›¾æ³¨æ„åŠ›å±‚3
    â†“ (ä¿¡æ¯åœ¨é‚»å±…é—´ä¼ æ’­)
QI_MAXé¢„æµ‹ (30000ç‚¹)
```

---

## ğŸ”§ å…³é”®æŠ€æœ¯ç»†èŠ‚

### 1. å›¾æ„å»ºï¼ˆGraph Constructionï¼‰

```python
def build_knn_graph(pos, k=6):
    """
    ä»åæ ‡æ„å»ºkè¿‘é‚»å›¾
    
    pos: [num_nodes, 2] = [30000, 2] (ç»åº¦ï¼Œçº¬åº¦)
    k: é‚»å±…æ•°é‡ = 6 (ICON icosahedralç½‘æ ¼å…¸å‹å€¼)
    
    è¿”å›: edge_index [2, num_edges]
    """
    edge_index = knn_graph(pos, k=6)
    return edge_index
```

**ç¤ºä¾‹**ï¼š
- 30,000ä¸ªèŠ‚ç‚¹
- æ¯ä¸ªèŠ‚ç‚¹6ä¸ªé‚»å±…
- æ€»è¾¹æ•° â‰ˆ 30,000 Ã— 6 = 180,000æ¡è¾¹

### 2. å›¾æ³¨æ„åŠ›æœºåˆ¶ï¼ˆGraph Attentionï¼‰

```python
class GATConv:
    """
    å¯¹äºæ¯ä¸ªèŠ‚ç‚¹i:
    1. æ”¶é›†é‚»å±…èŠ‚ç‚¹jçš„ç‰¹å¾
    2. è®¡ç®—æ³¨æ„åŠ›æƒé‡ Î±_ij (å“ªäº›é‚»å±…æ›´é‡è¦)
    3. åŠ æƒèšåˆ: h_i' = Î£ Î±_ij * h_j
    """
```

**ç‰©ç†æ„ä¹‰**ï¼š
- æ³¨æ„åŠ›æƒé‡è‡ªåŠ¨å­¦ä¹ å“ªäº›é‚»å±…å¯¹é¢„æµ‹æ›´é‡è¦
- ä¾‹å¦‚ï¼šä¸Šé£å‘çš„é‚»å±…å¯èƒ½æ¯”ä¸‹é£å‘æ›´é‡è¦

### 3. å¤šå¤´æ³¨æ„åŠ›ï¼ˆMulti-head Attentionï¼‰

```python
GATConv(in_channels=1, out_channels=32, heads=4)
# è¾“å‡ºç»´åº¦ = 32 Ã— 4 = 128
```

**ä½œç”¨**ï¼š
- 4ä¸ª"å¤´"å¹¶è¡Œå­¦ä¹ ä¸åŒçš„æ³¨æ„åŠ›æ¨¡å¼
- ç±»ä¼¼äºCNNçš„å¤šä¸ªå·ç§¯æ ¸
- æé«˜æ¨¡å‹è¡¨è¾¾èƒ½åŠ›

---

## ğŸ“¦ å®‰è£…æ­¥éª¤

### 1. å®‰è£…PyTorch Geometric

```bash
cd /work/mh1498/m301257/work/MEssE/scripts/plugin/scripts
chmod +x install_pytorch_geometric.sh
./install_pytorch_geometric.sh
```

### 2. éªŒè¯å®‰è£…

```bash
source /work/mh1498/m301257/work/MEssE/environment/python/py_venv/bin/activate
python -c "from torch_geometric.nn import GATConv; print('âœ“ PyG installed')"
```

---

## ğŸš€ ä½¿ç”¨GNNæ’ä»¶

### æ›¿æ¢æ’ä»¶æ–‡ä»¶

```bash
cd /work/mh1498/m301257/work/MEssE/scripts/plugin/scripts

# å¤‡ä»½åŸæ–‡ä»¶
cp comin_plugin.py comin_plugin_mlp_backup.py

# ä½¿ç”¨GNNç‰ˆæœ¬
cp comin_plugin_gnn.py comin_plugin.py
```

### æäº¤è¿è¡Œ

```bash
cd /work/mh1498/m301257/work/MEssE/experiment
../scripts/run_icon/run_icon_LAM.sh
```

---

## ğŸ“ˆ é¢„æœŸæ”¹è¿›

### æ€§èƒ½æå‡
1. **æ›´å¥½çš„ç©ºé—´å»ºæ¨¡**ï¼šåˆ©ç”¨é‚»å±…å…³ç³»
2. **æ›´å¿«çš„æ”¶æ•›**ï¼šç©ºé—´å…ˆéªŒåŠ é€Ÿå­¦ä¹ 
3. **æ›´é«˜çš„ç²¾åº¦**ï¼šæ•æ‰å±€éƒ¨æ¨¡å¼

### è®­ç»ƒæ—¥å¿—ç¤ºä¾‹

**GNNæ¨¡å¼**ï¼š
```
PyTorch Geometric is available - GNN mode enabled
number of domains: [1]
==============================================================
Initializing GNN model (Graph Neural Network)
==============================================================
Graph built: 30000 nodes, 180000 edges
Model initialized at 2021-07-14 00:00:00
Number of parameters: 12584

GNN Training on 30000 nodes
  Epoch 1/10, Loss: 250000.123456
  Epoch 4/10, Loss: 123456.789012
  Epoch 7/10, Loss: 45678.901234
  Epoch 10/10, Loss: 12345.678901
GNN training completed. Final loss: 12345.678901
Checkpoint saved. Average loss: 78901.234567
```

**MLPæ¨¡å¼ï¼ˆfallbackï¼‰**ï¼š
```
PyTorch Geometric not found - falling back to MLP mode
Initializing MLP model (fallback mode)
MLP Training: 200 batches
  Batch 1/200, Loss: 320936.8
  Batch 2/200, Loss: 245678.3
  ...
```

---

## âš™ï¸ è¶…å‚æ•°è°ƒæ•´

### GNNå‚æ•°

```python
# åœ¨ comin_plugin_gnn.py ä¸­å¯è°ƒæ•´ï¼š

# 1. é‚»å±…æ•°é‡
edge_index = build_knn_graph(pos, k=6)  # æ”¹ä¸ºk=8å°è¯•æ›´å¤šé‚»å±…

# 2. ç½‘ç»œå±‚æ•°
net = GNNNet(
    num_layers=3,        # å¢åŠ åˆ°4æˆ–5å±‚
    hidden_channels=32,  # å¢åŠ åˆ°64æé«˜å®¹é‡
    heads=4              # å¢åŠ åˆ°8ä¸ªå¤´
)

# 3. å­¦ä¹ ç‡
learning_rate = 0.001   # é™ä½åˆ°0.0005æ›´ç¨³å®š

# 4. æ¯ä¸ªæ—¶é—´æ­¥çš„è®­ç»ƒè½®æ•°
num_epochs_per_timestep = 10  # å¢åŠ åˆ°20è½®
```

---

## ğŸ” è°ƒè¯•å’Œç›‘æ§

### æŸ¥çœ‹è®­ç»ƒè¿›åº¦

```bash
# å®æ—¶ç›‘æ§SLURMè¾“å‡º
tail -f /work/mh1498/m301257/work/MEssE/experiment/slurm.<job_id>.out

# æŸ¥çœ‹æŸå¤±æ—¥å¿—
ls -lh /scratch/m/m301257/icon_exercise_comin/log_*.txt
```

### ç»˜åˆ¶æŸå¤±æ›²çº¿

```bash
cd /work/mh1498/m301257/work/MEssE/scripts/run_icon
./quick_plot_loss.sh <job_id>
```

---

## ğŸ†š MLP vs GNN å¯¹æ¯”æ€»ç»“

| ç‰¹æ€§ | MLP (åŸç‰ˆ) | GNN (æ–°ç‰ˆ) |
|------|-----------|-----------|
| **ç½‘ç»œç±»å‹** | å…¨è¿æ¥ç¥ç»ç½‘ç»œ | å›¾æ³¨æ„åŠ›ç½‘ç»œ |
| **è¾“å…¥å½¢å¼** | Reshapeä¸º(B,C,H) | å›¾ç»“æ„(nodes+edges) |
| **ç©ºé—´ä¿¡æ¯** | âŒ å¿½ç•¥ | âœ… æ˜¾å¼å»ºæ¨¡ |
| **è®­ç»ƒæ–¹å¼** | Mini-batch | Full-batch + å¤šepoch |
| **å‚æ•°é‡** | ~3,000 | ~12,000 |
| **é€‚ç”¨åœºæ™¯** | é€šç”¨ | éç»“æ„åŒ–ç½‘æ ¼ï¼ˆ**æœ€ä½³**ï¼‰ |
| **æ”¶æ•›é€Ÿåº¦** | ä¸­ç­‰ | æ›´å¿«ï¼ˆåˆ©ç”¨ç©ºé—´ç»“æ„ï¼‰ |
| **ç‰©ç†ä¸€è‡´æ€§** | ä½ | é«˜ï¼ˆç¬¦åˆå±€éƒ¨æ€§åŸç†ï¼‰ |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Fallbackæœºåˆ¶
- å¦‚æœPyTorch Geometricæœªå®‰è£…ï¼Œè‡ªåŠ¨é€€å›åˆ°MLPæ¨¡å¼
- ä¸ä¼šå¯¼è‡´è¿è¡Œå¤±è´¥

### 2. å†…å­˜ä½¿ç”¨
- GNNéœ€è¦å­˜å‚¨è¾¹ä¿¡æ¯ï¼ˆ~180,000æ¡è¾¹ï¼‰
- æ¯æ¡è¾¹å ç”¨16å­—èŠ‚ï¼ˆ2ä¸ªint64ï¼‰
- é¢å¤–å†…å­˜ â‰ˆ 180,000 Ã— 16 bytes â‰ˆ 2.7 MBï¼ˆå¾ˆå°ï¼‰

### 3. è®¡ç®—æ—¶é—´
- GNNåœ¨æ•´å›¾ä¸Šè®­ç»ƒ10ä¸ªepoch
- å¯èƒ½æ¯”MLPçš„200ä¸ªbatchç¨æ…¢
- ä½†æ”¶æ•›æ›´å¿«ï¼Œæ€»ä½“æ•ˆç‡æ›´é«˜

---

## ğŸ“ è¿›é˜¶ä¸»é¢˜

### 1. ä½¿ç”¨ICONåŸç”Ÿé‚»å±…ä¿¡æ¯

å¦‚æœICONæä¾›åŸç”Ÿçš„é‚»å±…ç´¢å¼•ï¼š
```python
# domain.cells.neighbor_idx  # ICONå†…ç½®é‚»å±…ä¿¡æ¯
# å¯ä»¥æ›¿ä»£k-NNå›¾æ„å»ºï¼Œæ›´å‡†ç¡®
```

### 2. å¼‚æ„å›¾ï¼ˆHeterogeneous Graphï¼‰
```python
# åŒºåˆ†ä¸åŒç±»å‹çš„è¾¹ï¼š
# - é™†åœ°-é™†åœ°
# - æµ·æ´‹-æµ·æ´‹
# - é™†åœ°-æµ·æ´‹è¾¹ç•Œ
```

### 3. æ—¶ç©ºå›¾ç¥ç»ç½‘ç»œï¼ˆSpatio-Temporal GNNï¼‰
```python
# ç»“åˆæ—¶é—´åºåˆ—ä¿¡æ¯ï¼š
# ä¸ä»…è€ƒè™‘ç©ºé—´é‚»å±…ï¼Œè¿˜è€ƒè™‘æ—¶é—´ä¸Šçš„å‰ä¸€ä¸ªçŠ¶æ€
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

### PyTorch Geometricæ–‡æ¡£
- å®˜æ–¹æ–‡æ¡£: https://pytorch-geometric.readthedocs.io/
- GATè®ºæ–‡: "Graph Attention Networks" (VeliÄkoviÄ‡ et al., 2018)

### GNNåœ¨æ°”è±¡ä¸­çš„åº”ç”¨
- GraphCast (DeepMind, 2023): ä½¿ç”¨GNNè¿›è¡Œå…¨çƒå¤©æ°”é¢„æŠ¥
- FourCastNet (NVIDIA, 2022): åŸºäºTransformerçš„å¤©æ°”é¢„æŠ¥

---

## âœ… å¿«é€Ÿæ£€æŸ¥æ¸…å•

å®‰è£…å‰ï¼š
- [ ] Pythonç¯å¢ƒå·²æ¿€æ´»
- [ ] PyTorchå·²å®‰è£…

å®‰è£…åï¼š
- [ ] PyTorch GeometricæˆåŠŸå¯¼å…¥
- [ ] æµ‹è¯•å›¾æ„å»ºåŠŸèƒ½æ­£å¸¸

è¿è¡Œå‰ï¼š
- [ ] æ’ä»¶æ–‡ä»¶å·²æ›¿æ¢
- [ ] åæ ‡æ•°æ®å¯ç”¨ï¼ˆcx_glb, cy_glbï¼‰

è¿è¡Œä¸­ï¼š
- [ ] çœ‹åˆ°"GNN mode enabled"
- [ ] å›¾æ„å»ºæˆåŠŸï¼ˆnodeså’Œedgesæ•°é‡ï¼‰
- [ ] æ¯ä¸ªæ—¶é—´æ­¥10ä¸ªepochçš„æŸå¤±è¾“å‡º

è¿è¡Œåï¼š
- [ ] æ£€æŸ¥ç‚¹æ–‡ä»¶åŒ…å«'use_gnn'æ ‡å¿—
- [ ] æŸå¤±æ›²çº¿å¹³æ»‘ä¸‹é™
- [ ] ä¸MLPç‰ˆæœ¬æ¯”è¾ƒæ•ˆæœ

---

**æ€»ç»“**ï¼šGNNæ˜¯å¤„ç†ICONéç»“æ„åŒ–ç½‘æ ¼çš„ç†æƒ³é€‰æ‹©ï¼Œå……åˆ†åˆ©ç”¨äº†ç©ºé—´æ‹“æ‰‘ç»“æ„ï¼Œç¬¦åˆå¤§æ°”ç‰©ç†çš„å±€éƒ¨æ€§åŸç†ï¼
